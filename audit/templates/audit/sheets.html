{% extends 'audit/base.html' %}

{% block title %}Sheets - BlackShield AuditSource{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>
            <i class="bi bi-table me-2" style="color: var(--bs-accent);"></i>
            Sheets
        </h2>
        <p class="text-muted mb-0">Main Audit Workpaper View - Control Requirements & Evidence</p>
    </div>
    <div class="col-md-6 text-end">
        {% if user_role == 'Admin' or user_role == 'Control Assessor' %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#engagementModal">
            <i class="bi bi-plus-circle"></i> New Engagement
        </button>
        {% if engagement and engagement.standards.exists and control_requests|length == 0 %}
        <form method="post" action="{% url 'generate_sheets' engagement.id %}" class="d-inline ms-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">
                <i class="bi bi-lightning-charge"></i> Generate Sheets
        </button>
        </form>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label">Select Engagement:</label>
        <select class="form-select" id="engagementSelect">
            <option value="">-- All Engagements --</option>
            {% for eng in engagements %}
            <option value="{{ eng.id }}" {% if engagement and engagement.id == eng.id %}selected{% endif %}>
                {{ eng.title }} ({{ eng.status }})
            </option>
            {% endfor %}
        </select>
    </div>
    {% if engagement %}
    <div class="col-md-4">
        <label class="form-label">Standards:</label>
        <div class="form-control-plaintext">
            {% for standard in engagement.standards.all %}
                <span class="badge bg-primary me-1">{{ standard.name }}</span>
            {% empty %}
                <span class="text-muted">No standards selected</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

{% if engagement %}
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-2">
                    <i class="bi bi-folder2-open me-2" style="color: var(--bs-accent);"></i>
                    {{ engagement.title }}
                </h5>
                <p class="card-text mb-0">
                    <span class="status-badge status-{{ engagement.status }}">{{ engagement.status }}</span>
                    {% if engagement.lead_auditor %}
                    <span class="ms-3" style="color: var(--bs-text-muted);">
                        <i class="bi bi-person-badge me-1"></i>
                        <strong>Lead Auditor:</strong> {{ engagement.lead_auditor.get_full_name|default:engagement.lead_auditor.username }}
                    </span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-body">
        <div class="sheets-table-wrapper" style="max-height: calc(100vh - 360px);">
            <table class="table table-hover table-striped dashboard-table">
                <colgroup>
                    <col style="width:120px">
                    <col style="width:300px">
                    <col style="width:180px">
                    <col style="width:280px">
                    <col style="width:280px">
                    <col style="width:180px">
                    <col style="width:220px">
                    <col style="width:200px">
                </colgroup>
                <thead>
                    <tr>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Control ID</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Control Description</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Test Applied</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Test Performed</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Test Results</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Requests</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Documents</th>
                        <th style="position: sticky; top: 0; z-index: 5; background: #020617;">Sign-offs</th>
                    </tr>
                    <tr class="sheets-filter-row">
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"><input type="text" class="form-control form-control-sm sheets-filter-input" data-column-index="0" placeholder="Filter ID"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"><input type="text" class="form-control form-control-sm sheets-filter-input" data-column-index="1" placeholder="Filter Description"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"><input type="text" class="form-control form-control-sm sheets-filter-input" data-column-index="2" placeholder="Filter Test Applied"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"><input type="text" class="form-control form-control-sm sheets-filter-input" data-column-index="3" placeholder="Filter Test Performed"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"><input type="text" class="form-control form-control-sm sheets-filter-input" data-column-index="4" placeholder="Filter Test Results"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"></th>
                        <th style="position: sticky; top: 44px; z-index: 4; background: #020617;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in control_requests %}
                    {% with control=item.control request_obj=item.request request_count=item.request_count requests=item.requests workpaper_count=item.workpaper_count workpaper_docs=item.workpaper_docs %}
                    {% with questionnaire_responses=control.get_questionnaire_responses %}
                    <tr>
                    <td>
                        <div class="control-textbox" role="textbox" aria-readonly="true">
                            <div class="fw-semibold">{{ control.control_id }}</div>
                            {% if control.control_name and control.control_name != control.control_id %}
                            <div class="text-muted small">{{ control.control_name }}</div>
                                                    {% endif %}
                            {% if questionnaire_responses %}
                            <div class="badge bg-info ms-1" data-bs-toggle="tooltip" data-bs-html="true" 
                                 title="<strong>Questionnaire Response (Read-only):</strong><br>
                                 {% for resp in questionnaire_responses %}
                                 <strong>{{ resp.answer }}</strong>{% if resp.response_text %}: {{ resp.response_text|truncatewords:10 }}{% endif %}<br>
                                 {% endfor %}<br><small><em>Reference only - not audit execution</em></small>">
                                <i class="bi bi-clipboard-check"></i> Q
                            </div>
                                                {% endif %}
                        </div>
                    </td>
                    <td>
                        <textarea class="form-control form-control-sm control-textbox" readonly>{{ control.control_description }}</textarea>
                    </td>
                    <td>
                        {% if can_upload_workpaper %}
                        <textarea class="form-control form-control-sm auto-save-field control-textbox" name="test_applied_{{ control.id }}" form="updateControl{{ control.id }}" data-control-id="{{ control.id }}" data-field-name="test_applied" placeholder="Describe test applied...">{% if control.test_applied %}{{ control.test_applied }}{% endif %}</textarea>
                                    {% else %}
                        <textarea class="form-control form-control-sm control-textbox" readonly>{% if control.test_applied %}{{ control.test_applied }}{% else %}-{% endif %}</textarea>
                                    {% endif %}
                    </td>
                    <td>
                        {% if can_upload_workpaper %}
                        <textarea class="form-control form-control-sm auto-save-field control-textbox" name="test_performed_{{ control.id }}" form="updateControl{{ control.id }}" data-control-id="{{ control.id }}" data-field-name="test_performed" placeholder="Describe testing performed...">{% if control.test_performed %}{{ control.test_performed }}{% endif %}</textarea>
                        {% else %}
                        <textarea class="form-control form-control-sm control-textbox" readonly>{% if control.test_performed %}{{ control.test_performed }}{% else %}-{% endif %}</textarea>
                                    {% endif %}
                    </td>
                    <td>
                        {% if can_upload_workpaper %}
                        <textarea class="form-control form-control-sm auto-save-field control-textbox" name="test_results_{{ control.id }}" form="updateControl{{ control.id }}" data-control-id="{{ control.id }}" data-field-name="test_results" placeholder="Audit conclusion (e.g., 'No exceptions noted')...">{{ control.test_results }}</textarea>
                            {% else %}
                        <textarea class="form-control form-control-sm control-textbox" readonly>{{ control.test_results|default:"-" }}</textarea>
                            {% endif %}
                        </td>
                    <td class="requests">
                        <div class="action-cell">
                        {% if request_count > 0 %}
                                <span class="badge bg-info me-1">
                                    <i class="bi bi-file-earmark-text"></i> 
                                    {{ request_count }} Request{{ request_count|pluralize }}
                                </span>
                            {% if request_obj %}
                                <a href="{% url 'request_detail' request_obj.id %}" class="btn btn-sm btn-outline-primary ms-1" title="View Request Details">
                                    <i class="bi bi-eye"></i> View
                                </a>
                                {% endif %}
                                {% if can_upload_evidence %}
                                <button class="btn btn-sm btn-outline-success ms-1" data-bs-toggle="modal" data-bs-target="#evidenceUploadModal{{ control.id }}" title="Upload Evidence">
                                    <i class="bi bi-upload"></i> Upload Evidence
                                                    </button>
                                                {% endif %}
                                    {% else %}
                            {% if user_role == 'Admin' or user_role == 'Control Assessor' or user_role == 'Control Reviewer' %}
                            <form method="post" action="{% url 'create_request' control.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus-circle"></i> Create Request
                                </button>
                            </form>
                            {% elif can_upload_evidence %}
                            <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#evidenceUploadModal{{ control.id }}" title="Upload Evidence">
                                <i class="bi bi-upload"></i> Upload Evidence
                                        </button>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                            {% endif %}
                        </div>
                        </td>
                        <td class="documents">
                            <div class="action-cell">
                            <span class="badge bg-secondary me-1">
                                <i class="bi bi-file-earmark-text"></i> {{ workpaper_count }} Workpaper{{ workpaper_count|pluralize }}
                            </span>
                            {% if can_upload_workpaper %}
                            <button class="btn btn-sm btn-outline-primary ms-1" data-bs-toggle="modal" data-bs-target="#workpaperModal{{ control.id }}" title="Upload Workpapers">
                                <i class="bi bi-plus-lg"></i> Add Document
                            </button>
                            {% endif %}
                            {% if workpaper_count > 0 %}
                            <button class="btn btn-sm btn-outline-secondary ms-1" data-bs-toggle="modal" data-bs-target="#documentsModal{{ control.id }}" title="View Documents">
                                <i class="bi bi-eye"></i> View
                            </button>
                            {% endif %}
                            </div>
                        </td>
                    <td class="signoffs">
                        <div class="action-cell">
                        <style>
                            .sign-pill { border-radius: 999px; padding: 4px 10px; }
                            .sign-pill.signed { pointer-events: none; cursor: default; }
                        </style>
                            {% if control.preparer_signed_at %}
                                <span class="badge bg-success sign-pill signed">
                                    <i class="bi bi-check2"></i> Signed
                                </span>
                                <span class="small text-muted">Preparer</span>
                                {% if item.can_undo_preparer %}
                                <form method="post" action="{% url 'undo_signoff_control' control.id %}"
                                      onsubmit="return confirm('Are you sure you want to undo this sign-off?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="role" value="preparer">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Undo</button>
                                </form>
                                {% endif %}
                            {% else %}
                                <form method="post" action="{% url 'signoff_control' control.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="role" value="preparer">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary sign-pill"
                                            {% if not can_sign_preparer %}disabled{% endif %}>
                                        Preparer
                                    </button>
                                </form>
                            {% endif %}

                            {% if control.reviewer_signed_at %}
                                <span class="badge bg-success sign-pill signed">
                                    <i class="bi bi-check2"></i> Signed
                                </span>
                                <span class="small text-muted">Reviewer</span>
                                {% if item.can_undo_reviewer %}
                                <form method="post" action="{% url 'undo_signoff_control' control.id %}"
                                      onsubmit="return confirm('Are you sure you want to undo this sign-off?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="role" value="reviewer">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Undo</button>
                                </form>
                                {% endif %}
                            {% else %}
                                <form method="post" action="{% url 'signoff_control' control.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="role" value="reviewer">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary sign-pill"
                                            {% if not can_sign_reviewer %}disabled{% endif %}>
                                        Reviewer
                                    </button>
                                </form>
                            {% endif %}
                        <div class="mt-1 small text-muted">
                            {% if control.preparer_signed_at %}P: {{ control.preparer_signed_by.get_full_name|default:control.preparer_signed_by.username }} on {{ control.preparer_signed_at|date:"Y-m-d" }}{% endif %}
                            {% if control.reviewer_signed_at %}{% if control.preparer_signed_at %} | {% endif %}R: {{ control.reviewer_signed_by.get_full_name|default:control.reviewer_signed_by.username }} on {{ control.reviewer_signed_at|date:"Y-m-d" }}{% endif %}
                        </div>
                        </div>
                    </td>
                    </tr>
                    
                    {% if can_upload_workpaper %}
                    <!-- Hidden form for updating control fields -->
                    <form method="post" action="{% url 'update_control' control.id %}" id="updateControl{{ control.id }}" style="display: none;">
                        {% csrf_token %}
                    </form>
                    
                    <!-- Workpaper Upload Modal for Control -->
                    <div class="modal fade" id="workpaperModal{{ control.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Upload Workpaper</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="post" action="{% url 'upload_workpaper_control' control.id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Workpaper Files (Select multiple files)</label>
                                            <input type="file" class="form-control" name="workpaper_files" accept=".pdf,.doc,.docx,.xls,.xlsx" multiple>
                                            <small class="form-text text-muted">You can select and upload multiple files at once.</small>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-success">Upload</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Evidence Upload Modal from Sheets -->
                    {% if can_upload_evidence %}
                    <div class="modal fade" id="evidenceUploadModal{{ control.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Upload Evidence – {{ control.control_id }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="post" action="{% url 'upload_evidence_from_sheets' control.id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        {% if request_obj %}
                                        <input type="hidden" name="request_id" value="{{ request_obj.id }}">
                                        <div class="alert alert-info mb-3">
                                            Evidence will be attached to: Evidence Request for {{ control.control_id }} ({{ request_obj.status }})
                                        </div>
                                        {% else %}
                                        <input type="hidden" name="request_id" value="">
                                        <div class="alert alert-info mb-3">
                                            Evidence will be attached to: Evidence Request for {{ control.control_id }} (Open)
                                        </div>
                                        {% endif %}
                                        <div class="mb-3">
                                            <label class="form-label">Upload Evidence Files <span class="text-danger">*</span></label>
                                            <input type="file" class="form-control" name="evidence_files" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.csv,.txt" multiple required>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-upload"></i> Upload Evidence
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if request_obj %}
                    <!-- Request Details Modal -->
                    <div class="modal fade" id="requestModal{{ request_obj.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Request Details: {{ request_obj.title|default:"Evidence Request" }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>Status:</strong> 
                                        {% if request_obj.status == 'OPEN' %}
                                        <span class="badge bg-primary">Open</span>
                                        {% elif request_obj.status == 'READY_FOR_REVIEW' %}
                                        <span class="badge bg-warning text-dark">Ready for Review</span>
                                        {% elif request_obj.status == 'COMPLETED' %}
                                        <span class="badge bg-success">Completed</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ request_obj.status }}</span>
                                        {% endif %}
                                    </div>
                                    {% if request_obj.description %}
                                    <div class="mb-3">
                                        <strong>Description:</strong>
                                        <p>{{ request_obj.description }}</p>
                                    </div>
                                    {% endif %}
                                    {% with evidence_docs=request_obj.documents.all %}
                                    {% if evidence_docs %}
                                    <div class="mb-3">
                                        <strong>Evidence Documents ({{ evidence_docs|length }}):</strong>
                                        <ul class="list-group mt-2">
                                            {% for doc in evidence_docs %}
                                            {% if doc.doc_type == 'evidence' %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <a href="{{ doc.file.url }}" target="_blank">
                                                    <i class="bi bi-file-earmark-pdf text-danger"></i> {{ doc.get_file_name }}
                                                </a>
                                                <small class="text-muted">{{ doc.uploaded_at|date:"M d, Y" }}</small>
                                            </li>
                                            {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">No evidence documents uploaded yet.</div>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evidence Upload Modal -->
                    <div class="modal fade" id="evidenceModal{{ request_obj.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Upload Evidence</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="post" action="{% url 'upload_evidence' request_obj.id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Evidence Files (Select multiple files)</label>
                                            <input type="file" class="form-control" name="evidence_files" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" multiple required>
                                            <small class="form-text text-muted">You can select and upload multiple files at once.</small>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">Upload</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Workpaper Upload Modal -->
                    <div class="modal fade" id="workpaperModal{{ request_obj.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Upload Workpaper & Test Notes</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="post" action="{% url 'upload_workpaper' request_obj.id %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Workpaper Files (Select multiple files)</label>
                                            <input type="file" class="form-control" name="workpaper_files" accept=".pdf,.doc,.docx,.xls,.xlsx" multiple>
                                            <small class="form-text text-muted">You can select and upload multiple files at once.</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Test Performed <span class="text-danger">*</span></label>
                                            <textarea class="form-control" name="auditor_test_notes" rows="4" required>{{ request_obj.auditor_test_notes }}</textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-success">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    {% endif %}
                    
                    {% if can_upload_workpaper %}
                    <!-- Documents View Modal -->
                    <div class="modal fade" id="documentsModal{{ control.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Workpapers for Control {{ control.control_id }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    {% if workpaper_docs %}
                                    <ul class="list-group">
                                        {% for doc in workpaper_docs %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <a href="{{ doc.file.url }}" target="_blank">
                                                <i class="bi bi-file-earmark-text text-primary"></i> {{ doc.get_file_name }}
                                            </a>
                                            <div>
                                                <small class="text-muted me-2">{{ doc.uploaded_at|date:"M d, Y" }}</small>
                                                <form method="post" action="{% url 'delete_document' doc.id %}" onsubmit="return confirm('Delete this workpaper?');" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <div class="alert alert-info">No workpapers uploaded yet.</div>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}  {# Close questionnaire_responses with #}
                    {% endwith %}  {# Close control/request with #}
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">No controls found. {% if user_role == 'Admin' %}Create a control to get started.{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Engagement Modal - Redirect -->
<div class="modal fade" id="engagementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Engagement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Redirecting to engagement creation form...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'create_engagement' %}" class="btn btn-primary">Go to Form</a>
            </div>
        </div>
    </div>
</div>

<!-- Control Modal - Redirect -->
<div class="modal fade" id="controlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Control</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Redirecting to control creation form...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'create_control' %}{% if engagement %}?engagement={{ engagement.id }}{% endif %}" class="btn btn-success">Go to Form</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const engagementSelect = document.getElementById('engagementSelect');
        const yearSelect = document.getElementById('yearSelect');
        const yearFilterContainer = document.getElementById('year-filter-container');
        
        // Handle engagement selection change
        if (engagementSelect) {
            engagementSelect.addEventListener('change', function() {
                const engagementId = this.value;
                
                if (engagementId) {
                    // Redirect to dashboard with engagement parameter
                    // The backend will provide available years and show/hide the year filter
                    window.location.href = '?engagement=' + engagementId;
                } else {
                    // No engagement selected, go to base URL
                    window.location.href = '{% url "dashboard" %}';
                }
            });
        }
        
        // Handle year selection change
        if (yearSelect && engagementSelect) {
            yearSelect.addEventListener('change', function() {
                const engagementId = engagementSelect.value;
                const year = this.value;
                
                if (engagementId) {
                    let url = '?engagement=' + engagementId;
                    if (year) {
                        url += '&year=' + year;
                    }
                    window.location.href = url;
                }
            });
        }
        
        // Force enable all buttons in modals
        function enableModalButtons() {
            document.querySelectorAll('.modal button').forEach(function(btn) {
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
                btn.style.position = 'relative';
                btn.style.zIndex = '9999';
                btn.disabled = false;
            });
        }

        // Enable buttons immediately
        enableModalButtons();

        // Enable buttons when modals are shown
        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('show.bs.modal', function() {
                enableModalButtons();
            });
            modal.addEventListener('shown.bs.modal', function() {
                enableModalButtons();
            });
        });

        // Initialize tooltips for questionnaire badges
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Auto-save control fields using AJAX (field-level only)
        const autoSaveTimeouts = new Map();
        const saveIndicators = new Map();
        const autosaveUrl = "{% url 'autosave_control_field' %}";

        // Create save indicator for each field
        document.querySelectorAll('[data-control-id][data-field-name]').forEach(function(field) {
            const indicator = document.createElement('small');
            indicator.style.cssText = 'position: absolute; right: 5px; top: 5px; color: #6c757d; font-size: 0.75rem; display: none;';
            indicator.className = 'save-indicator';

            const parent = field.parentElement;
            if (parent && parent.style.position !== 'relative') {
                parent.style.position = 'relative';
            }
            parent.appendChild(indicator);
            saveIndicators.set(field, indicator);

            field.addEventListener('input', function() {
                const indicatorEl = saveIndicators.get(field);
                if (indicatorEl) {
                    indicatorEl.textContent = '...';
                    indicatorEl.style.display = 'inline';
                    indicatorEl.style.color = '#6c757d';
                }

                if (autoSaveTimeouts.has(field)) {
                    clearTimeout(autoSaveTimeouts.get(field));
                }

                autoSaveTimeouts.set(field, setTimeout(function() {
                    autoSaveField(field);
                }, 800));
            });

            field.addEventListener('blur', function() {
                if (autoSaveTimeouts.has(field)) {
                    clearTimeout(autoSaveTimeouts.get(field));
                    autoSaveTimeouts.delete(field);
                }
                autoSaveField(field);
            });

            // Prevent Enter from submitting hidden update_control forms
            field.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
        });

        function autoSaveField(field) {
            const controlId = field.dataset.controlId;
            const fieldName = field.dataset.fieldName;
            if (!controlId || !fieldName) return;

            const indicator = saveIndicators.get(field);
            if (indicator) {
                indicator.textContent = 'Saving...';
                indicator.style.display = 'inline';
                indicator.style.color = '#0d6efd';
            }

            const formData = new FormData();
            formData.append('control_id', controlId);
            formData.append('field_name', fieldName);
            formData.append('value', field.value);

            console.log(controlId, fieldName, field.value);

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(autosaveUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (indicator) {
                        indicator.textContent = 'Saved ✓';
                        indicator.style.color = '#198754';
                        setTimeout(function() {
                            indicator.style.display = 'none';
                        }, 2000);
                    }
                } else if (indicator) {
                    indicator.textContent = 'Error!';
                    indicator.style.color = '#dc3545';
                }
            })
            .catch(error => {
                console.error('Auto-save error:', error);
                if (indicator) {
                    indicator.textContent = 'Error!';
                    indicator.style.color = '#dc3545';
                    setTimeout(function() {
                        indicator.style.display = 'none';
                    }, 3000);
                }
            });
        }

        // Make sure form submissions work
        document.querySelectorAll('.modal form').forEach(function(form) {
            // Remove any event listeners that might prevent submission
            form.onsubmit = null;
            
            form.addEventListener('submit', function(e) {
                console.log('Form submitting:', this.action);
                var submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
                // Don't prevent default - let form submit normally
                return true;
            }, false);

            // Also handle button clicks directly
            var submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    console.log('Submit button clicked');
                    // Let the form handle submission
                    var form = this.closest('form');
                    if (form) {
                        form.submit();
                    }
                }, false);
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.dashboard-table');
        const filters = document.querySelectorAll('.sheets-filter-input');
        if (!table || filters.length === 0) return;

        const rows = table.querySelectorAll('tbody tr');

        function applyFilters() {
            const activeFilters = Array.from(filters).map(input => ({
                index: parseInt(input.dataset.columnIndex, 10),
                value: input.value.trim().toLowerCase(),
            }));

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = true;
                activeFilters.forEach(filter => {
                    if (!filter.value) return;
                    const cellText = cells[filter.index]?.innerText.toLowerCase() || '';
                    if (!cellText.includes(filter.value)) {
                        match = false;
                    }
                });
                row.style.display = match ? '' : 'none';
            });
        }

        filters.forEach(input => {
            input.addEventListener('keyup', applyFilters);
        });
    });
</script>
{% endblock %}
