{% extends 'audit/base.html' %}

{% block title %}Dashboard - BlackShield AuditSource{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>
            <i class="bi bi-speedometer2 me-2" style="color: var(--bs-accent);"></i>
            Dashboard
        </h2>
        <p class="text-muted mb-0">High-Level Engagement Summary & Metrics</p>
    </div>
    <div class="col-md-6 text-end">
        <label class="form-label">Select Engagement:</label>
        <select class="form-select d-inline-block w-auto ms-2" id="engagementSelect">
            <option value="">-- All Engagements --</option>
            {% for eng in engagements %}
            <option value="{{ eng.id }}" {% if engagement and engagement.id == eng.id %}selected{% endif %}>
                {{ eng.title }} ({{ eng.status }})
            </option>
            {% endfor %}
        </select>
    </div>
</div>

{% if engagement %}
<div class="row mb-4">
    <!-- Row Sign-offs Percentage -->
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-subtitle text-muted">Row Sign-offs</h6>
                    <i class="bi bi-check-circle text-success" style="font-size: 1.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ row_signoffs_percent }}%</h3>
                <small class="text-muted">Accepted controls</small>
            </div>
        </div>
    </div>

    <!-- Document Sign-offs Percentage -->
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-subtitle text-muted">Document Sign-offs</h6>
                    <i class="bi bi-file-earmark-check text-primary" style="font-size: 1.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ doc_signoffs_percent }}%</h3>
                <small class="text-muted">Requests with documents</small>
            </div>
        </div>
    </div>

    <!-- Requests Completion Percentage -->
    <div class="col-md-3 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-subtitle text-muted">Requests Completion</h6>
                    <i class="bi bi-inbox text-info" style="font-size: 1.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ requests_completion_percent }}%</h3>
                <small class="text-muted">Non-open requests</small>
            </div>
        </div>
    </div>

    <!-- Tasks Completion Percentage -->
    <div class="col-md-3 mb-3">
        <div class="card h-100">
    <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-subtitle text-muted">Tasks Completion</h6>
                    <i class="bi bi-clipboard-check text-warning" style="font-size: 1.5rem;"></i>
                </div>
                <h3 class="mb-0">{{ tasks_completion_percent }}%</h3>
                <small class="text-muted">Requests with test notes</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
<div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Recent Activity
                </h5>
            </div>
    <div class="card-body">
                {% if recent_requests %}
        <div class="table-responsive">
                    <table class="table table-hover">
                <thead>
                    <tr>
                                <th>Control ID</th>
                                <th>Status</th>
                                <th>Test Performed</th>
                                <th>Reviewed By</th>
                                <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody>
                            {% for req in recent_requests %}
                            <tr>
                                <td><strong>{{ req.linked_control.control_id }}</strong></td>
                                <td>
                                    {% if req.status == 'OPEN' %}
                                    <span class="badge bg-primary">Open</span>
                                    {% elif req.status == 'READY_FOR_REVIEW' %}
                                    <span class="badge bg-warning text-dark">Ready for Review</span>
                                    {% elif req.status == 'COMPLETED' %}
                                    <span class="badge bg-success">Completed</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ req.status }}</span>
                                    {% endif %}
                        </td>
                        <td>
                                    {% if req.auditor_test_notes %}
                                        <i class="bi bi-check-circle text-success"></i> Yes
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                                    {% if req.reviewed_by %}
                                        {{ req.reviewed_by.get_full_name|default:req.reviewed_by.username }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                                <td>{{ req.updated_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
                {% else %}
                <p class="text-muted mb-0">No recent activity.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    Please select an engagement to view dashboard metrics.
</div>
{% endif %}

<script>
document.getElementById('engagementSelect').addEventListener('change', function() {
    const engagementId = this.value;
    const url = new URL(window.location.href);
    if (engagementId) {
        url.searchParams.set('engagement', engagementId);
    } else {
        url.searchParams.delete('engagement');
    }
    window.location.href = url.toString();
    });
</script>
{% endblock %}
