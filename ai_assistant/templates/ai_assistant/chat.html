{% extends "audit/base.html" %}
{% load static %}

{% block title %}AI Assistant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ai_assistant/css/ai_assistant.css' %}">
{% endblock %}

{% block content %}
<div class="ai-assistant">
    <div class="ai-main">
        <div class="ai-header">
            <div class="ai-header-left">
                <h4>AI Assistant</h4>
                <span class="ai-subtle">Ask questions, attach documents, get answers.</span>
            </div>
            <div class="ai-header-actions">
                <button class="btn btn-sm btn-outline-light" id="historyToggle">
                    <i class="bi bi-clock-history"></i> History
                </button>
                <button class="btn btn-sm btn-outline-light" id="newConversationBtn">
                    <i class="bi bi-plus-lg"></i> New Chat
                </button>
            </div>
        </div>

        <div class="ai-upload-row">
            <form id="uploadForm" class="ai-upload" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="document" id="documentInput" accept=".pdf,.docx,.txt,.xls,.xlsx">
                <button type="submit" class="btn btn-sm btn-primary">Upload</button>
                <span class="ai-upload-status" id="uploadStatus"></span>
            </form>
        </div>

        <div class="ai-chat">
            <div class="chat-messages" id="messageList">
                {% if active_conversation %}
                    {% for msg in messages %}
                    <div class="ai-message {{ msg.role }}">
                        <div class="ai-message-content">{{ msg.content }}</div>
                        <div class="ai-message-time">{{ msg.created_at|date:"H:i" }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="ai-empty">Start a new conversation by sending a message.</div>
                {% endif %}
            </div>
            <div class="chat-input sticky-bottom">
                <form id="chatForm" class="ai-input">
                    {% csrf_token %}
                    <input type="hidden" id="conversationId" value="{% if active_conversation %}{{ active_conversation.id }}{% endif %}">
                    <textarea id="messageInput" rows="3" placeholder="Ask a question..."></textarea>
                    <div class="ai-input-actions">
                        <button type="submit" class="btn btn-success">Send</button>
                    </div>
                    <div class="ai-input-status" id="chatStatus"></div>
                </form>
            </div>
        </div>
    </div>

    <aside class="chat-history ai-history-drawer hidden" id="historyDrawer" aria-hidden="true">
        <div class="ai-history-header">
            <h5>History</h5>
            <button class="btn btn-sm btn-outline-light" id="historyClose">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="ai-history-list">
            {% for convo in conversations %}
            <a class="ai-conversation-item {% if active_conversation and convo.id == active_conversation.id %}active{% endif %}"
               href="{% url 'ai_assistant_home' %}?conversation={{ convo.id }}">
                <span class="ai-conversation-title">{{ convo.title }}</span>
                <small class="text-muted">{{ convo.created_at|date:"M d, Y â€¢ H:i" }}</small>
            </a>
            {% empty %}
            <div class="ai-empty">No conversations yet.</div>
            {% endfor %}
        </div>
        <div class="ai-documents">
            <h6>Documents</h6>
            <ul>
                {% for doc in documents %}
                <li>{{ doc.file.name|cut:"ai_assistant/uploads/" }}</li>
                {% empty %}
                <li class="text-muted">No documents uploaded.</li>
                {% endfor %}
            </ul>
        </div>
    </aside>
    <div class="ai-history-backdrop hidden" id="historyBackdrop" aria-hidden="true"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('uploadForm');
        const documentInput = document.getElementById('documentInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const messageList = document.getElementById('messageList');
        const conversationIdInput = document.getElementById('conversationId');
        const chatStatus = document.getElementById('chatStatus');
        const newConversationBtn = document.getElementById('newConversationBtn');
        const historyToggle = document.getElementById('historyToggle');
        const historyDrawer = document.getElementById('historyDrawer');
        const historyBackdrop = document.getElementById('historyBackdrop');
        const historyClose = document.getElementById('historyClose');

        if (newConversationBtn) {
            newConversationBtn.addEventListener('click', function() {
                conversationIdInput.value = '';
                messageList.innerHTML = '<div class="ai-empty">Start a new conversation by sending a message.</div>';
            });
        }

        function closeHistory() {
            if (historyDrawer) {
                historyDrawer.classList.remove('open');
                historyDrawer.classList.add('hidden');
                historyDrawer.setAttribute('aria-hidden', 'true');
            }
            if (historyBackdrop) {
                historyBackdrop.classList.remove('open');
                historyBackdrop.classList.add('hidden');
                historyBackdrop.setAttribute('aria-hidden', 'true');
            }
        }

        if (historyToggle) {
            historyToggle.addEventListener('click', function() {
                if (historyDrawer && historyBackdrop) {
                    historyDrawer.classList.remove('hidden');
                    historyDrawer.classList.add('open');
                    historyDrawer.setAttribute('aria-hidden', 'false');
                    historyBackdrop.classList.remove('hidden');
                    historyBackdrop.classList.add('open');
                    historyBackdrop.setAttribute('aria-hidden', 'false');
                }
            });
        }

        if (historyClose) {
            historyClose.addEventListener('click', closeHistory);
        }

        if (historyBackdrop) {
            historyBackdrop.addEventListener('click', closeHistory);
        }

        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!documentInput.files.length) {
                    uploadStatus.textContent = 'Select a file first.';
                    return;
                }
                const formData = new FormData(uploadForm);
                uploadStatus.textContent = 'Uploading...';

                fetch("{% url 'ai_assistant_upload' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        uploadStatus.textContent = 'Uploaded';
                        setTimeout(() => { uploadStatus.textContent = ''; }, 2000);
                        documentInput.value = '';
                        window.location.reload();
                    } else {
                        uploadStatus.textContent = data.error || 'Upload failed.';
                    }
                })
                .catch(() => {
                    uploadStatus.textContent = 'Upload failed.';
                });
            });
        }

        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message) {
                    chatStatus.textContent = 'Enter a message.';
                    return;
                }
                chatStatus.textContent = 'Sending...';

                const formData = new FormData();
                formData.append('message', message);
                if (conversationIdInput.value) {
                    formData.append('conversation_id', conversationIdInput.value);
                }

                fetch("{% url 'ai_assistant_chat' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': chatForm.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        conversationIdInput.value = data.conversation_id;
                        appendMessage('User', message, 'user');
                        appendMessage('Assistant', data.answer || '', 'assistant');
                        messageInput.value = '';
                        chatStatus.textContent = '';
                    } else {
                        chatStatus.textContent = data.error || 'Send failed.';
                    }
                })
                .catch(() => {
                    chatStatus.textContent = 'AI Assistant is offline. Please start Ollama.';
                });
            });
        }

        if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
        }

        function appendMessage(label, content, role) {
            const wrapper = document.createElement('div');
            wrapper.className = 'ai-message ' + role;

            const contentEl = document.createElement('div');
            contentEl.className = 'ai-message-content';
            contentEl.textContent = content;

            const timeEl = document.createElement('div');
            timeEl.className = 'ai-message-time';
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            wrapper.appendChild(contentEl);
            wrapper.appendChild(timeEl);
            messageList.appendChild(wrapper);
            messageList.scrollTop = messageList.scrollHeight;
        }
    });
</script>
{% endblock %}
